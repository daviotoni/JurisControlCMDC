<script type="module">
/* ===== 1) IMPORTS E CONFIG ===== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import { getAuth, setPersistence, browserLocalPersistence, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
import { getFirestore, collection, doc, addDoc, setDoc, getDoc, getDocs, query, orderBy, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

/* Substitua pelos dados do seu projeto */
const firebaseConfig = {
  apiKey: "SUA-API-KEY",
  authDomain: "SEU-PROJETO.firebaseapp.com",
  projectId: "SEU-PROJETO",
  storageBucket: "SEU-PROJETO.appspot.com",
  messagingSenderId: "XXXXXXXXXXXX",
  appId: "1:XXXXXXXXXXXX:web:YYYYYYYYYYYYYY"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ===== 2) LOGIN / LOGOUT ===== */
const loginOverlay = document.getElementById('loginOverlay');           /* já existe no seu HTML */            /*  */
const btnEntrar     = document.getElementById('btnEntrar');             /*  */
const btnSair       = document.getElementById('btnSair');               /*  */
const userInput     = document.getElementById('loginUser');             /*  */
const passInput     = document.getElementById('loginPass');             /*  */
const loginErro     = document.getElementById('loginErro');             /*  */
const welcomeMsg    = document.getElementById('welcomeMsg');            /* header à direita */                 /*  */

setPersistence(auth, browserLocalPersistence);

btnEntrar?.addEventListener('click', async () => {
  loginErro.textContent = "";
  try {
    const email = userInput.value.trim();
    const pass  = passInput.value;
    if (!email || !pass) throw new Error("Preencha e-mail e senha.");
    await signInWithEmailAndPassword(auth, email, pass);
  } catch (e) {
    loginErro.textContent = e.message || "Falha no login.";
  }
});

btnSair?.addEventListener('click', async () => {
  await signOut(auth);
});

onAuthStateChanged(auth, (user) => {
  if (user) {
    loginOverlay.style.display = 'none';
    welcomeMsg.textContent = `Olá, ${user.email}`;
    // Carregar dados iniciais
    renderProcessos();
  } else {
    welcomeMsg.textContent = "";
    loginOverlay.style.display = 'flex';
    clearProcessosUI();
  }
});

/* ===== 3) FIRESTORE: COLEÇÕES ===== */
const colProcessos  = collection(db, 'processos');
const colComentarios= collection(db, 'comentarios');

/* ===== 4) CRIAR/EDITAR PROCESSO (usa seu #f_proc) ===== */
const fProc     = document.getElementById('f_proc');                    /*  */
const tabelaTbody = document.getElementById('tbl-body');                /*  */
const mobileCards = document.getElementById('mobile-cards-container');  /*  */

function formToObj(form) {
  const fd = new FormData(form);
  const obj = Object.fromEntries(fd.entries());
  // normalizações simples
  obj.createdAt = obj.createdAt || null;
  obj.updatedAt = new Date().toISOString();
  return obj;
}

fProc?.addEventListener('submit', async (e) => {
  e.preventDefault();
  const obj = formToObj(fProc);

  // Validações básicas
  if (!obj.num || !obj.int || !obj.ent) {
    alert("Preencha Nº, Interessado e Entrada.");
    return;
  }
  // Se tiver ID, atualiza; senão cria
  const id = obj.id?.trim();
  try {
    if (id) {
      const ref = doc(db, 'processos', id);
      await updateDoc(ref, {
        ...obj,
        updatedAt: serverTimestamp()
      });
    } else {
      await addDoc(colProcessos, {
        ...obj,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      });
    }
    // Fechar modal e recarregar
    document.querySelector('[data-close-proc]')?.click();
    await renderProcessos();
    showToast("Processo salvo com sucesso.");
  } catch (err) {
    console.error(err);
    alert("Erro ao salvar processo.");
  }
});

/* ===== 5) LISTAR PROCESSOS NA TABELA/CARDS ===== */
function clearProcessosUI() {
  if (tabelaTbody) tabelaTbody.innerHTML = "";
  if (mobileCards) mobileCards.innerHTML = "";
}

async function renderProcessos() {
  if (!tabelaTbody) return;
  clearProcessosUI();

  // Ordenar por data de entrada (string yyyy-mm-dd); ajuste se quiser por createdAt
  const qSnap = await getDocs(query(colProcessos, orderBy('ent', 'desc')));

  qSnap.forEach((docSnap) => {
    const p = docSnap.data();
    const id = docSnap.id;

    // TABELA (desktop)
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><strong>${p.num || ''}</strong><br><span>${p.int || ''}</span></td>
      <td>${p.obj || ''}</td>
      <td style="text-align:center"><span class="status ${p.stat||'pendente'}">${labelStatus(p.stat)}</span></td>
      <td style="text-align:center">${p.prazo || '-'}</td>
      <td style="text-align:center">
        <button class="btn secondary" data-view="${id}">Ver</button>
      </td>
    `;
    tabelaTbody.appendChild(tr);

    // CARDS (mobile)
    if (mobileCards) {
      const card = document.createElement('div');
      card.className = 'proc-card';
      card.innerHTML = `
        <div class="proc-card-header">
          <div class="num">${p.num||''}</div>
          <span class="status ${p.stat||'pendente'}">${labelStatus(p.stat)}</span>
        </div>
        <div class="proc-card-body">
          <div class="item"><strong>Interessado:</strong> ${p.int||''}</div>
          <div class="item"><strong>Objeto:</strong> ${p.obj||''}</div>
          <div class="item"><strong>Prazo:</strong> ${p.prazo||'-'}</div>
        </div>
        <div class="proc-card-footer">
          <button class="btn secondary" data-view="${id}">Ver</button>
        </div>
      `;
      mobileCards.appendChild(card);
    }
  });

  // Ação “Ver” → abre modal de visualização e carrega comentários
  document.querySelectorAll('[data-view]').forEach(btn => {
    btn.addEventListener('click', () => openViewModal(btn.getAttribute('data-view')));
  });
}

function labelStatus(s) {
  const map = {
    'pendente':'Pendente',
    'em-analise':'Em Análise',
    'aguardando-documentacao':'Aguardando Documentação',
    'em-diligencia':'Em Diligência',
    'finalizado':'Finalizado',
    'arquivado':'Arquivado'
  };
  return map[s] || 'Pendente';
}

/* ===== 6) VISUALIZAÇÃO + COMENTÁRIOS (simples) ===== */
const mView      = document.getElementById('m_proc_view');            /*  */
const viewBody   = document.getElementById('view-details-content');   /* onde mostra os dados */ /*  */

async function openViewModal(id) {
  const ref = doc(db, 'processos', id);
  const snap = await getDoc(ref);
  if (!snap.exists()) return alert("Processo não encontrado.");

  const p = snap.data();
  // Render detalhes
  viewBody.innerHTML = `
    <div class="view-section">
      <h4>Dados do Processo</h4>
      <div class="view-grid">
        <div class="view-item"><strong>Nº</strong><p>${p.num||''}</p></div>
        <div class="view-item"><strong>Interessado</strong><p>${p.int||''}</p></div>
        <div class="view-item"><strong>Status</strong><p>${labelStatus(p.stat)}</p></div>
        <div class="view-item"><strong>Entrada</strong><p>${p.ent||''}</p></div>
        <div class="view-item"><strong>Prazo</strong><p>${p.prazo||'-'}</p></div>
        <div class="view-item full-width"><strong>Objeto</strong><p>${p.obj||''}</p></div>
      </div>
    </div>

    <div class="view-section" id="commentsSection">
      <h4>Comentários</h4>
      <div id="commentList" style="display:flex;flex-direction:column;gap:.5rem;"></div>
      <div style="display:flex;gap:.5rem;margin-top:.75rem;">
        <input id="newComment" class="input" placeholder="Escreva um comentário..." />
        <button id="addCommentBtn" class="btn primary">Comentar</button>
      </div>
    </div>
  `;

  // Carrega comentários
  await renderComments(id);

  // Bind comentar
  document.getElementById('addCommentBtn')?.addEventListener('click', async () => {
    const input = document.getElementById('newComment');
    const texto = input.value.trim();
    if (!texto) return;
    const user = auth.currentUser;
    await addDoc(colComentarios, {
      processoId: id,
      texto,
      autorEmail: user?.email || 'desconhecido',
      createdAt: serverTimestamp()
    });
    input.value = '';
    await renderComments(id);
    showToast("Comentário adicionado.");
  });

  // Abre modal
  mView.style.display = 'flex';
});

document.querySelector('[data-close-view]')?.addEventListener('click', () => {
  mView.style.display = 'none';
});

async function renderComments(processoId) {
  const listEl = document.getElementById('commentList');
  if (!listEl) return;
  listEl.innerHTML = '';
  // Simples: ordena por createdAt no cliente (poderia usar orderBy em createdAt se existir)
  const snaps = await getDocs(colComentarios);
  const items = [];
  snaps.forEach(s => {
    const c = s.data();
    if (c.processoId === processoId) items.push(c);
  });
  // Ordena por createdAt se existir timestamp
  items.sort((a,b) => (a.createdAt?.seconds||0) - (b.createdAt?.seconds||0));

  for (const c of items) {
    const li = document.createElement('div');
    const when = c.createdAt ? new Date(c.createdAt.seconds*1000).toLocaleString() : '';
    li.className = 'view-item';
    li.innerHTML = `<strong>${c.autorEmail||'Alguém'}</strong><p>${c.texto}</p><span style="font-size:.8rem;color:var(--text-muted)">${when}</span>`;
    listEl.appendChild(li);
  }
}

/* ===== 7) BACKUP / RESTORE (JSON) ===== */
const btnBackupDown = document.getElementById('bk_down');  /*  */
const btnBackupUp   = document.getElementById('bk_up');    /*  */
const inpBackupFile = document.getElementById('bk_file');  /*  */

btnBackupDown?.addEventListener('click', async () => {
  const processos = [];
  const comentarios = [];

  const pSnap = await getDocs(colProcessos);
  pSnap.forEach(s => processos.push({ id: s.id, ...s.data() }));

  const cSnap = await getDocs(colComentarios);
  cSnap.forEach(s => comentarios.push({ id: s.id, ...s.data() }));

  const json = JSON.stringify({ exportAt: new Date().toISOString(), processos, comentarios }, null, 2);
  const blob = new Blob([json], { type: 'application/json' });
  const url  = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `juriscontrol-backup-${Date.now()}.json`;
  a.click();
  URL.revokeObjectURL(url);
  showToast("Backup gerado.");
});

btnBackupUp?.addEventListener('click', () => {
  inpBackupFile?.click();
});

inpBackupFile?.addEventListener('change', async (e) => {
  const file = e.target.files?.[0];
  if (!file) return;
  const txt = await file.text();
  const data = JSON.parse(txt);

  // Restaura processos (merge simples por ID — se não existir, cria com ID fixo)
  for (const p of (data.processos||[])) {
    const ref = doc(db, 'processos', p.id);
    await setDoc(ref, p, { merge: true });
  }
  // Restaura comentários
  for (const c of (data.comentarios||[])) {
    const ref = doc(db, 'comentarios', c.id);
    await setDoc(ref, c, { merge: true });
  }
  await renderProcessos();
  showToast("Backup restaurado.");
});

/* ===== 8) TOAST SIMPLES (usa seu #toast-container se existir) ===== */
function showToast(msg) {
  // usa o seu container se já existir; se não, cria temporário
  let cont = document.getElementById('toast-container');                /*  */
  if (!cont) {
    cont = document.createElement('div');
    cont.id = 'toast-container';
    cont.style.position = 'fixed';
    cont.style.top = '1.25rem';
    cont.style.right = '1.25rem';
    cont.style.zIndex = '9999';
    document.body.appendChild(cont);
  }
  const el = document.createElement('div');
  el.className = 'toast info';
  el.style.background = 'var(--card-bg)';
  el.style.color = 'var(--text-primary)';
  el.style.borderLeft = '4px solid var(--info)';
  el.style.padding = '1rem';
  el.style.marginTop = '.5rem';
  el.style.borderRadius = '10px';
  el.textContent = msg;
  cont.appendChild(el);
  setTimeout(() => el.remove(), 3500);
}
</script>
